<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gemini Voice â€” Mobile</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<style>
  :root{
    --bg1:#031124;
    --bg2:#05162b;
    --accent1:#4dd0e1;
    --accent2:#7c4dff;
    --glass: rgba(255,255,255,0.06);
    --bubble-user: linear-gradient(90deg,#3b82f6,#2563eb);
    --bubble-assistant: linear-gradient(180deg,#0b1220,#071024);
    color-scheme: dark;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:Inter,system-ui,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));display:flex;align-items:flex-start;justify-content:center;padding:18px}
  .shell{width:100%;max-width:760px;border-radius:18px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(2,6,23,0.6);backdrop-filter: blur(6px);}
  .top{display:flex;align-items:center;gap:12px;padding:14px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:#021; font-weight:700}
  .title{color: #e6f7ff;font-weight:700;font-size:16px}
  .subtitle{font-size:12px;color:#9fb3c7}
  .chat{padding:14px;max-height:62vh;overflow:auto}
  .bubble{max-width:84%;padding:12px 14px;border-radius:14px;margin:8px 0;word-break:break-word;box-shadow:0 6px 16px rgba(2,6,23,0.6)}
  .bubble.user{margin-left:auto;border-bottom-right-radius:6px;background:var(--bubble-user);color:white}
  .bubble.assistant{margin-right:auto;background:linear-gradient(180deg,#07172a,#05223d);color:#d6f7ff;border-bottom-left-radius:6px}
  .meta{font-size:12px;color:#9fb3c7;margin-top:6px}
  .controls{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid rgba(255,255,255,0.03)}
  .mic{width:66px;height:66px;border-radius:50%;border:none;background:linear-gradient(180deg,#081826,#063042);display:grid;place-items:center;color:white;font-size:26px;box-shadow:0 8px 26px rgba(7,18,28,0.6);cursor:pointer}
  .mic.listening{box-shadow:0 12px 36px rgba(124,77,255,0.22);transform:scale(1.04)}
  .inputWrap{flex:1;display:flex;gap:8px;align-items:center}
  .textInput{flex:1;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#dff;outline:none}
  .sendBtn{padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021;border:none;cursor:pointer}
  .typingDots span{display:inline-block;width:6px;height:6px;margin:0 2px;border-radius:50%;background:#8bdcff;animation:dot 1s infinite}
  .typingDots span:nth-child(2){animation-delay:.12s} .typingDots span:nth-child(3){animation-delay:.24s}
  @keyframes dot{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  @media (max-width:420px){.mic{width:58px;height:58px;font-size:22px}}
</style>
</head>
<body>
  <div class="shell">
    <div class="top">
      <div class="logo">G</div>
      <div>
        <div class="title">Gemini Voice</div>
        <div class="subtitle">Speak â€” chat â€” hear. Powered by OpenAI (server side).</div>
      </div>
    </div>

    <div id="chat" class="chat">
      <div class="bubble assistant">
        <div style="font-weight:700">Assistant</div>
        <div style="margin-top:6px;color:#cfefff">Hi â€” tap the mic and speak. I will reply with voice and text.</div>
      </div>
    </div>

    <div class="controls">
      <button id="mic" class="mic" title="Speak">ðŸŽ¤</button>
      <div class="inputWrap">
        <input id="text" class="textInput" placeholder="Type a message..." />
        <button id="send" class="sendBtn">Send</button>
      </div>
    </div>
  </div>

<script>
  // front-end logic: speech -> /api/chat -> display -> /api/tts -> play
  const micBtn = document.getElementById('mic');
  const chatEl = document.getElementById('chat');
  const textInput = document.getElementById('text');
  const sendBtn = document.getElementById('send');

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  if(SpeechRecognition){
    recognition = new SpeechRecognition();
    recognition.lang = 'en-IN';
    recognition.interimResults = false;
  } else {
    micBtn.disabled = true;
    micBtn.title = "SpeechRecognition unsupported (use Chrome on Android)";
  }

  let listening = false;
  let conversation = [
    { role: "system", content: "You are a helpful assistant with a friendly Gemini-like persona." }
  ];

  function addBubble(role, text, isTyping=false){
    const div = document.createElement('div');
    div.className = 'bubble ' + (role==='user' ? 'user' : 'assistant');
    const inner = document.createElement('div');
    inner.innerHTML = `<div style="font-weight:600">${role==='user' ? 'You' : 'Assistant'}</div>`;
    const content = document.createElement('div');
    content.style.marginTop = '8px';
    if(isTyping){
      content.innerHTML = '<div class="typingDots"><span></span><span></span><span></span></div>';
    } else {
      content.textContent = text;
    }
    inner.appendChild(content);
    div.appendChild(inner);
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    return div;
  }

  function playBase64Audio(b64, mime){
    const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const blob = new Blob([bytes.buffer], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = new Audio(url);
    a.onended = ()=> URL.revokeObjectURL(url);
    a.play().catch(e=> console.warn("Playback failed", e));
  }

  async function sendMessage(text){
    // show user bubble
    addBubble('user', text);
    conversation.push({ role: 'user', content: text });

    // show assistant typing
    const typingBubble = addBubble('assistant', '', true);

    try{
      // send to server
      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: conversation })
      });
      const j = await r.json();
      const reply = j.reply || "Sorry, I couldn't generate a reply.";

      // replace typing with real text
      typingBubble.querySelector('div > div:nth-child(2)').textContent = reply;
      conversation.push({ role: 'assistant', content: reply });

      // ask TTS
      const tts = await fetch('/api/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: reply, voice: "alloy" })
      });
      const tj = await tts.json();
      if(tts.ok && tj.audioBase64){
        playBase64Audio(tj.audioBase64, tj.mime || 'audio/mpeg');
      } else {
        console.warn("TTS failed", tj);
      }
    } catch(err){
      console.error(err);
      typingBubble.querySelector('div > div:nth-child(2)').textContent = "Error: couldn't reach server.";
    }
  }

  // send from text input
  sendBtn.addEventListener('click', ()=> {
    const val = textInput.value.trim();
    if(!val) return;
    textInput.value = '';
    sendMessage(val);
  });

  textInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ sendBtn.click(); } });

  // mic logic
  micBtn.addEventListener('click', ()=>{
    if(!recognition) return alert('SpeechRecognition unsupported. Use Chrome/Edge on Android.');
    if(!listening){
      recognition.start();
      listening = true;
      micBtn.classList.add('listening');
      micBtn.textContent = 'â—';
    } else {
      recognition.stop();
      listening = false;
      micBtn.classList.remove('listening');
      micBtn.textContent = 'ðŸŽ¤';
    }
  });

  if(recognition){
    recognition.onresult = (e)=>{
      const transcript = Array.from(e.results).map(r=>r[0].transcript).join('');
      // auto-send final transcript
      sendMessage(transcript);
      if(listening){ recognition.stop(); listening=false; micBtn.classList.remove('listening'); micBtn.textContent='ðŸŽ¤'; }
    };
    recognition.onerror = (ev)=> {
      console.error("recognition error", ev);
      listening=false; micBtn.classList.remove('listening'); micBtn.textContent='ðŸŽ¤';
      alert("Speech recognition error: " + (ev.error || 'unknown'));
    };
    recognition.onend = ()=> { listening=false; micBtn.classList.remove('listening'); micBtn.textContent='ðŸŽ¤'; };
  }

  // small welcome ping
  window.addEventListener('load', ()=> {
    setTimeout(()=> {
      // don't auto speak â€” wait for user
    }, 400);
  });

</script>
</body>
</html>
